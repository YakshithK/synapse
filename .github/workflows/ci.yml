name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.12"

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e ".[dev]"

    - name: Run linting
      run: |
        black --check synapse/
        isort --check-only synapse/
        flake8 --max-line-length=88 --ignore=E203,W503 synapse/

    - name: Upload coverage
      uses: codecov/codecov-action@v3

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build package
      run: |
        pip install build
        python -m build

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  release:
    name: Release Package
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN || secrets.PAT_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Extract version from setup.py
      id: version
      run: |
        python -c "import re; content = open('setup.py').read(); version = re.search(r'version=\"([^\"]+)\"', content).group(1); print(f'v{version}')" > version.txt
        echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT
        echo "VERSION=$(cat version.txt)" >> $GITHUB_ENV

    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse --verify "refs/tags/${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi

    - name: Download build artifacts
      if: steps.check_tag.outputs.should_release == 'true'
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/

    - name: Create Git Tag
      if: steps.check_tag.outputs.should_release == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
        git push origin ${{ steps.version.outputs.version }}

    - name: Publish to PyPI
      if: steps.check_tag.outputs.should_release == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}

  auto_merge_dev_to_main:
    name: Auto-merge dev to main
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-merge dev to main
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: "Auto-merge: dev to main",
              head: 'dev',
              base: 'main',
              body: 'Automated merge from dev to main',
              maintainer_can_modify: true,
              draft: false
            });

            // Auto-merge the PR
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });

  auto_pr_to_dev:
    name: Auto-merge feature to dev
    runs-on: ubuntu-latest
    needs: test
    if: |
      startsWith(github.ref, 'refs/heads/feat/') &&
      github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Auto-merge to dev
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = process.env.GITHUB_REF.replace('refs/heads/', '');

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: `Auto-merge: ${branch} to dev`,
              head: branch,
              base: 'dev',
              body: `Automated merge from ${branch} to dev`,
              maintainer_can_modify: true,
              draft: false
            });

            // Auto-merge the PR
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: pr.number,
              merge_method: 'squash'
            });

  version_management:
    name: Version Management
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') &&
      github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install bump2version

      - name: Bump version
        if: github.ref == 'refs/heads/dev'
        run: |
          # Get current branch and last commit message
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

          # Only bump if the last commit was not a version bump
          if ! git log -1 --pretty=%B | grep -q 'Bump version:'; then
            # Bump patch version (0.1.0 -> 0.1.1)
            bump2version patch --no-tag --no-commit
            git add .
            git commit -m "chore: bump version [skip ci]"
            git push origin dev
          fi

      - name: Tag release
        if: github.ref == 'refs/heads/main'
        run: |
          # Get version from setup.py
          VERSION=$(python -c "import re; content = open('setup.py').read(); print(re.search(r'version=\"([^\"]+)\"', content).group(1))")

          # Check if the version was bumped in the dev branch before the merge
          if git log --grep='chore: bump version' -1 dev | grep -q 'chore: bump version'; then
            # Get the last version bump commit from dev
            LAST_VERSION_BUMP=$(git log --grep='chore: bump version' -1 --pretty=format:"%H" dev)

            # Check if this version bump is already tagged
            if ! git describe --exact-match --tags $LAST_VERSION_BUMP 2>/dev/null; then
              # Create and push tag if not already tagged
              echo "Creating new release tag v$VERSION"
              git tag -a "v$VERSION" -m "Release $VERSION"
              git push origin "v$VERSION"
            else
              echo "Version $VERSION was already tagged"
            fi
          else
            echo "No version bump detected in dev branch, skipping tag creation"
          fi
